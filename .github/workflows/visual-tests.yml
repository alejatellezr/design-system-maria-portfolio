name: ğŸ¨ Design System Quality Checks

on:
  pull_request:
    branches: [main]
    paths:
      - "stories/**"
      - ".storybook/**"
      - "src/**"
      - "styles/**"

jobs:
  design-system-checks:
    name: ğŸ¨ Design System Validation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Storybook
        run: npm run build-storybook
        env:
          NODE_OPTIONS: --max_old_space_size=4096

      - name: ğŸ” Validate Storybook Structure
        run: |
          echo "ğŸ” Validating Storybook build structure..."

          # Check if essential files exist
          if [ ! -f "storybook-static/index.html" ]; then
            echo "âŒ Storybook index.html not found"
            exit 1
          fi

          if [ ! -f "storybook-static/index.json" ]; then
            echo "âŒ Storybook index.json not found"
            exit 1
          fi

          echo "âœ… Storybook structure validation passed"

      - name: ğŸ¨ Check CSS Custom Properties
        run: |
          echo "ğŸ¨ Checking for CSS custom properties (design tokens)..."

          # Look for CSS custom properties in build
          if find storybook-static -name "*.css" -exec grep -l "var(--" {} \; | head -1; then
            echo "âœ… CSS custom properties found - design tokens are being used"
          else
            echo "âš ï¸ No CSS custom properties detected - consider using design tokens"
          fi

      - name: ï¿½ Check Theme Support
        run: |
          echo "ï¿½ Checking for theme support..."

          # Check for theme-related files or configurations
          if grep -r "theme\|dark\|light" storybook-static/ --include="*.js" --include="*.json" | head -1; then
            echo "âœ… Theme support detected"
          else
            echo "âš ï¸ No theme support detected"
          fi

      - name: â™¿ Basic Accessibility Validation
        run: |
          echo "â™¿ Running basic accessibility checks..."

          # Check for accessibility attributes in stories
          if find stories -name "*.jsx" -o -name "*.js" | xargs grep -l "aria-\|role=\|alt=" | head -1; then
            echo "âœ… Accessibility attributes found in stories"
          else
            echo "âš ï¸ Consider adding accessibility attributes to components"
          fi

          # Check for semantic HTML elements
          if find stories -name "*.jsx" -o -name "*.js" | xargs grep -l "<button\|<nav\|<main\|<header\|<footer" | head -1; then
            echo "âœ… Semantic HTML elements found"
          else
            echo "âš ï¸ Consider using semantic HTML elements"
          fi

      - name: ï¿½ Component Coverage Report
        run: |
          echo "ğŸ“Š Generating component coverage report..."

          # Count total components
          TOTAL_COMPONENTS=$(find stories/components -name "*.jsx" | wc -l)

          # Count components with stories
          COMPONENTS_WITH_STORIES=$(find stories/components -name "*.stories.js" | wc -l)

          echo "ğŸ“ˆ Component Statistics:"
          echo "  - Total components: $TOTAL_COMPONENTS"
          echo "  - Components with stories: $COMPONENTS_WITH_STORIES"

          if [ $COMPONENTS_WITH_STORIES -gt 0 ] && [ $TOTAL_COMPONENTS -gt 0 ]; then
            COVERAGE=$((COMPONENTS_WITH_STORIES * 100 / TOTAL_COMPONENTS))
            echo "  - Story coverage: $COVERAGE%"
            
            if [ $COVERAGE -lt 50 ]; then
              echo "âš ï¸ Story coverage is below 50% - consider adding more stories"
            else
              echo "âœ… Good story coverage"
            fi
          fi

      - name: ğŸ“ Generate Summary
        run: |
          echo "ğŸ“ Design System Quality Summary:"
          echo "âœ… Storybook builds successfully"
          echo "âœ… Static quality checks completed"
          echo "ğŸ’¡ For visual regression testing, consider setting up Chromatic or similar tools"
          echo "ğŸ’¡ For comprehensive accessibility testing, consider adding axe-core or similar tools"
