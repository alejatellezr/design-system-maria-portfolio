name: ğŸ” CI - Build & Quality Checks

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  install-dependencies:
    name: ğŸ“¦ Install Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ“¤ Cache node_modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

  lint-and-format:
    name: ğŸ“ Code Quality
    runs-on: ubuntu-latest
    needs: install-dependencies

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“š Restore dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

      - name: ğŸ“š Install dependencies (if cache miss)
        run: npm ci

      - name: ğŸ” Run ESLint
        run: |
          if npm run lint 2>/dev/null; then
            echo "âœ… ESLint passed"
          else
            echo "âš ï¸ ESLint not configured or failed - skipping"
          fi

      - name: ğŸ’… Check Prettier formatting
        run: |
          if npm run format:check 2>/dev/null; then
            echo "âœ… Prettier formatting is correct"
          else
            echo "âš ï¸ Prettier not configured or formatting issues - skipping"
          fi

  storybook-build:
    name: ğŸ—ï¸ Storybook Build Test
    runs-on: ubuntu-latest
    needs: install-dependencies

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“š Restore dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

      - name: ğŸ“š Install dependencies (if cache miss)
        run: npm ci

      - name: ğŸ” Check for case sensitivity issues
        run: |
          echo "ğŸ” Scanning for potential case sensitivity issues..."
          # Check for mismatched import paths
          find stories -name "*.jsx" -o -name "*.js" -o -name "*.ts" -o -name "*.tsx" | xargs grep -l "import.*from.*[A-Z]" | while read file; do
            echo "Checking $file for case sensitivity..."
            grep "import.*from.*[A-Z]" "$file" || true
          done

      - name: ğŸ—ï¸ Build Storybook
        run: |
          echo "ğŸ—ï¸ Building Storybook..."
          npm run build-storybook 2>&1 | tee storybook-build.log

          # Check for actual build failures (not warnings)
          if grep -q "Failed to build" storybook-build.log; then
            echo "âŒ Storybook build failed"
            cat storybook-build.log
            exit 1
          fi

          if grep -q "CaseSensitivePathsPlugin" storybook-build.log; then
            echo "âŒ Case sensitivity error detected"
            cat storybook-build.log
            exit 1
          fi

          if grep -q "Module not found" storybook-build.log; then
            echo "âŒ Module not found error detected"
            cat storybook-build.log
            exit 1
          fi

          if grep -q "Error:" storybook-build.log && ! grep -q "Process completed with exit code 1" storybook-build.log; then
            echo "âŒ Build error detected"
            cat storybook-build.log
            exit 1
          fi

          # Check if build completed successfully
          if grep -q "Preview built" storybook-build.log && [ -d "storybook-static" ]; then
            echo "âœ… Storybook build successful"
            
            # Report warnings but don't fail
            if grep -q "WARN.*Sass @import rules are deprecated" storybook-build.log; then
              echo "âš ï¸ SASS deprecation warnings detected - consider migrating @import to @use"
              echo "ğŸ“– See: https://sass-lang.com/d/import"
            fi
            
            if grep -q "asset size limit" storybook-build.log; then
              echo "âš ï¸ Bundle size warnings detected - consider optimization"
            fi
          else
            echo "âŒ Storybook build failed - no output directory found"
            cat storybook-build.log
            exit 1
          fi
        env:
          NODE_OPTIONS: --max_old_space_size=4096

      - name: ğŸ“¤ Upload Storybook build
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: storybook-build-${{ github.sha }}
          path: storybook-static/
          retention-days: 7

      - name: ğŸ“¤ Upload build logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: storybook-build-logs-${{ github.sha }}
          path: storybook-build.log
          retention-days: 3

      - name: ğŸ“ SASS Migration Suggestions
        if: success()
        run: |
          # Count warnings for reporting
          SASS_WARNINGS=$(grep -c "Sass @import rules are deprecated" storybook-build.log || echo "0")

          if [ "$SASS_WARNINGS" -gt 0 ]; then
            echo "ğŸ“ SASS Migration Recommendations:"
            echo ""
            echo "ğŸ”„ To fix $SASS_WARNINGS SASS deprecation warnings, consider:"
            echo "1. Replace @import with @use/@forward in SASS files"
            echo "2. Update import paths to use relative paths instead of absolute"
            echo "3. Use the automated migrator: sass-migrator division **/*.scss"
            echo ""
            echo "ğŸ“– Learn more: https://sass-lang.com/documentation/at-rules/use"
          else
            echo "âœ… No SASS deprecation warnings found"
          fi

  webpack-validation:
    name: âš™ï¸ Webpack Configuration Check
    runs-on: ubuntu-latest
    needs: install-dependencies

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“š Restore dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

      - name: ğŸ“š Install dependencies (if cache miss)
        run: npm ci

      - name: ğŸ” Validate webpack config
        run: |
          echo "ğŸ” Validating webpack configuration..."

          # Check if .storybook config files exist
          if [ ! -f ".storybook/main.js" ]; then
            echo "âŒ .storybook/main.js not found"
            exit 1
          fi

          # Validate Storybook config syntax
          node -c .storybook/main.js
          if [ -f ".storybook/preview.js" ]; then
            node -c .storybook/preview.js
          fi

          echo "âœ… Storybook configuration is valid"

  dependency-check:
    name: ğŸ”’ Security & Dependency Check
    runs-on: ubuntu-latest
    needs: install-dependencies

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ”’ Run security audit
        run: |
          echo "ğŸ”’ Running npm security audit..."
          npm audit --audit-level=moderate
        continue-on-error: true

      - name: ğŸ“¦ Check for outdated packages
        run: |
          echo "ğŸ“¦ Checking for outdated packages..."
          npm outdated || true

  status-check:
    name: âœ… All Checks Passed
    runs-on: ubuntu-latest
    needs:
      [lint-and-format, storybook-build, webpack-validation, dependency-check]
    if: always()

    steps:
      - name: âœ… Check all jobs status
        run: |
          if [[ "${{ needs.lint-and-format.result }}" == "success" && 
                "${{ needs.storybook-build.result }}" == "success" && 
                "${{ needs.webpack-validation.result }}" == "success" ]]; then
            echo "ğŸ‰ All quality checks passed!"
            echo "âœ… Code formatting: PASSED"
            echo "âœ… Storybook build: PASSED"
            echo "âœ… Webpack validation: PASSED"
          else
            echo "âŒ Some checks failed:"
            echo "ğŸ“ Code formatting: ${{ needs.lint-and-format.result }}"
            echo "ğŸ—ï¸ Storybook build: ${{ needs.storybook-build.result }}"
            echo "âš™ï¸ Webpack validation: ${{ needs.webpack-validation.result }}"
            exit 1
          fi
