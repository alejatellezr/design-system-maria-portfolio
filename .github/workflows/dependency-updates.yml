name: ðŸ”„ Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  dependency-updates:
    name: ðŸ”„ Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ“š Install dependencies
        run: npm ci
        
      - name: ðŸ” Check for updates
        run: |
          echo "ðŸ” Checking for dependency updates..."
          npm outdated --json > outdated.json || true
          
          if [ -s outdated.json ] && [ "$(cat outdated.json)" != "{}" ]; then
            echo "ðŸ“¦ Updates available:"
            cat outdated.json
            echo "HAS_UPDATES=true" >> $GITHUB_ENV
          else
            echo "âœ… All dependencies are up to date"
            echo "HAS_UPDATES=false" >> $GITHUB_ENV
          fi
          
      - name: ðŸ”„ Update patch and minor versions
        if: env.HAS_UPDATES == 'true'
        run: |
          echo "ðŸ”„ Updating patch and minor versions..."
          npx npm-check-updates -u --target minor
          npm install
          
      - name: ðŸ§ª Test updates
        if: env.HAS_UPDATES == 'true'
        run: |
          echo "ðŸ§ª Testing updated dependencies..."
          npm run build-storybook
          
      - name: ðŸ“¤ Create PR for updates
        if: env.HAS_UPDATES == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'ðŸ”„ chore: automated dependency updates'
          body: |
            ## ðŸ”„ Automated Dependency Updates
            
            This PR contains automated updates to patch and minor versions of dependencies.
            
            ### Changes
            - Updated dependencies to latest patch/minor versions
            - Verified Storybook build still works
            
            ### Testing
            - [x] Storybook build successful
            - [ ] Manual testing required
            
            ### Notes
            - Only patch and minor updates are included (no breaking changes)
            - Please review and test before merging
            
            _This PR was created automatically by the dependency update workflow._
          branch: chore/dependency-updates
          delete-branch: true

  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ“š Install dependencies
        run: npm ci
        
      - name: ðŸ”’ Run security audit
        run: |
          echo "ðŸ”’ Running security audit..."
          npm audit --audit-level=moderate --json > audit.json || true
          
          # Check if there are vulnerabilities
          if jq -e '.vulnerabilities | length > 0' audit.json > /dev/null; then
            echo "âš ï¸ Security vulnerabilities found:"
            npm audit
            
            # Try to fix automatically
            echo "ðŸ”§ Attempting automatic fixes..."
            npm audit fix
            
            # Check if fixes resolved issues
            npm audit --audit-level=moderate --json > audit-after-fix.json || true
            
            if jq -e '.vulnerabilities | length > 0' audit-after-fix.json > /dev/null; then
              echo "âŒ Some vulnerabilities could not be auto-fixed"
              echo "SECURITY_ISSUES=true" >> $GITHUB_ENV
            else
              echo "âœ… All vulnerabilities resolved"
              echo "SECURITY_FIXES=true" >> $GITHUB_ENV
            fi
          else
            echo "âœ… No security vulnerabilities found"
          fi
          
      - name: ðŸ“¤ Create security fix PR
        if: env.SECURITY_FIXES == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix: resolve security vulnerabilities'
          title: 'ðŸ”’ fix: automated security vulnerability fixes'
          body: |
            ## ðŸ”’ Security Vulnerability Fixes
            
            This PR contains automated fixes for security vulnerabilities found by npm audit.
            
            ### Changes
            - Applied `npm audit fix` to resolve security issues
            - Updated vulnerable dependencies to secure versions
            
            ### Testing
            - [x] Security audit passed after fixes
            - [ ] Manual testing required
            
            ### Priority
            **ðŸš¨ HIGH PRIORITY** - Security fixes should be reviewed and merged promptly.
            
            _This PR was created automatically by the security audit workflow._
          branch: fix/security-vulnerabilities
          delete-branch: true
          
      - name: ðŸš¨ Create security issue
        if: env.SECURITY_ISSUES == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Security vulnerabilities require manual attention',
              body: `## ðŸš¨ Security Alert
              
              Automated security fixes could not resolve all vulnerabilities.
              
              ### Action Required
              - Review the security audit output
              - Manually update vulnerable dependencies
              - Test for breaking changes
              
              ### Commands to run locally:
              \`\`\`bash
              npm audit
              npm audit fix
              \`\`\`
              
              _This issue was created automatically by the security audit workflow._`,
              labels: ['security', 'high-priority', 'dependencies']
            })
